# LoadSettings

# loadSettings

현재 작업 디렉토리 경로를 받아서 `LoadedSettings` 객체를 반환하는 함수

`settings.ts` 파일에서 정의되어 있으며, 이 함수는 여러 설정 파일을 로드하고 병합하여 최종 설정을 반환

```typescript
loadEnvironment();
let systemSettings: Settings = {};
let userSettings: Settings = {};
let workspaceSettings: Settings = {};
const settingsErrors: SettingsError[] = [];
const systemSettingsPath = getSystemSettingsPath();
```

* loadEnvironment : **dotenv** 패키지를 사용하여 `.env` 파일에서 환경 변수 로드
* 여러 세팅값 들을 초기화
  * `systemSettings` : 시스템 설정
  * `userSettings` : 사용자 설정
  * `workspaceSettings` : 작업 공간 설정
  * `settingsErrors` : 설정 에러 목록
* `getSystemSettingsPath` : OS별로 다른 시스템 설정 경로 가져오기


## loadEnvironment

```typescript
export function loadEnvironment(): void {
  const envFilePath = findEnvFile(process.cwd());

  if (process.env.CLOUD_SHELL === 'true') {
    setUpCloudShellEnvironment(envFilePath);
  }

  if (envFilePath) {
    dotenv.config({ path: envFilePath, quiet: true });
  }
}
```

## getSystemSettingsPath

```typescript
export function getSystemSettingsPath(): string {
  if (process.env.GEMINI_CLI_SYSTEM_SETTINGS_PATH) {
    return process.env.GEMINI_CLI_SYSTEM_SETTINGS_PATH;
  }
  if (platform() === 'darwin') {
    return '/Library/Application Support/GeminiCli/settings.json';
  } else if (platform() === 'win32') {
    return 'C:\\ProgramData\\gemini-cli\\settings.json';
  } else {
    return '/etc/gemini-cli/settings.json';
  }
}
```

여기선 user 설정을 로드하는것 까지만 정리

```typescript
import path from 'path';
import { homedir } from 'os';

export const SETTINGS_DIRECTORY_NAME = '.gemini';
export const USER_SETTINGS_DIR = path.join(homedir(), SETTINGS_DIRECTORY_NAME);
export const USER_SETTINGS_PATH = path.join(USER_SETTINGS_DIR, 'settings.json');
```

`settings.ts` 최상단 세팅값, 이것 이외에도 여러 타입들과 위 함수들(loadSettings, getSystemSettingsPath 등)도 정의되어 있음

```typescript
// Load user settings
try {
  if (fs.existsSync(USER_SETTINGS_PATH)) {
    const userContent = fs.readFileSync(USER_SETTINGS_PATH, 'utf-8');
    const parsedUserSettings = JSON.parse(
      stripJsonComments(userContent),
    ) as Settings;
    userSettings = resolveEnvVarsInObject(parsedUserSettings);
    // Support legacy theme names
    if (userSettings.theme && userSettings.theme === 'VS') {
      userSettings.theme = DefaultLight.name;
    } else if (userSettings.theme && userSettings.theme === 'VS2015') {
      userSettings.theme = DefaultDark.name;
    }
  }
} catch (error: unknown) {
  settingsErrors.push({
    message: getErrorMessage(error),
    path: USER_SETTINGS_PATH,
  });
}
```

1. `./gemini/settings.json` 파일을 utf-8 로 읽기
2. `stripJsonComments` 함수를 사용하여 주석 제거
3. JSON 파싱 후 `Settings` 타입으로 변환
4. `resolveEnvVarsInObject` 함수를 사용하여 환경 변수 치환
  * 설정값 내의 `$VAR_NAME` 또는 `${VAR_NAME}` 형태의 환경변수를 실제 값으로 치환
5. 에러 발생시 `settingsErrors` 배열에 에러 메시지와 경로 추가

### resolveEnvVarsInObject

```typescript
function resolveEnvVarsInString(value: string): string {
  const envVarRegex = /\$(?:(\w+)|{([^}]+)})/g; // Find $VAR_NAME or ${VAR_NAME}
  return value.replace(envVarRegex, (match, varName1, varName2) => {
    const varName = varName1 || varName2;
    if (process && process.env && typeof process.env[varName] === 'string') {
      return process.env[varName]!;
    }
    return match;
  });
}

function resolveEnvVarsInObject<T>(obj: T): T {
  if (
    obj === null ||
    obj === undefined ||
    typeof obj === 'boolean' ||
    typeof obj === 'number'
  ) {
    return obj;
  }

  if (typeof obj === 'string') {
    return resolveEnvVarsInString(obj) as unknown as T;
  }

  if (Array.isArray(obj)) {
    return obj.map((item) => resolveEnvVarsInObject(item)) as unknown as T;
  }

  if (typeof obj === 'object') {
    const newObj = { ...obj } as T;
    for (const key in newObj) {
      if (Object.prototype.hasOwnProperty.call(newObj, key)) {
        newObj[key] = resolveEnvVarsInObject(newObj[key]);
      }
    }
    return newObj;
  }

  return obj;
}
```