# Settings Type

> Gemini CLI 의 모든 설정 옵션을 정의, 설정은 User, Workspace, System 세가지 레벨로 나뉘며, 같은 타입을 사용

현재 사용중인 테마, 사용자 정의 테마, 선택된 인증 방식, MCP 서버 등등을 중앙 에서 관리하는 객체

> AuthType 은 core 에 정의되어 있음

```typescript
export enum AuthType {
  LOGIN_WITH_GOOGLE = 'oauth-personal',
  USE_GEMINI = 'gemini-api-key',
  USE_VERTEX_AI = 'vertex-ai',
  CLOUD_SHELL = 'cloud-shell',
}

export interface Settings {
  theme?: string;
  customThemes?: Record<string, CustomTheme>;
  selectedAuthType?: AuthType;
  useExternalAuth?: boolean;
  sandbox?: boolean | string;
  ...
  // Git-aware file filtering settings
  fileFiltering?: {
    respectGitIgnore?: boolean;
    respectGeminiIgnore?: boolean;
    enableRecursiveFileSearch?: boolean;
  };
  ...
  // Environment variables to exclude from project .env files
  excludedProjectEnvVars?: string[];
  dnsResolutionOrder?: DnsResolutionOrder;
}
```

# LoadedSettings

> 세가지 레벨의 설정 (System, User, Workspace) 을 로그하고 병합하는 로직을 담당

핵심 로직인 `computeMergedSettings()` 메서드는 설정들을 덮어쓰는 방식으로 병합

최종족으론 `system > workspace > user` 순으로 병합됨

**초기화 로직**

```typescript
export interface SettingsError {
  message: string;
  path: string;
}

export interface SettingsFile {
  settings: Settings;
  path: string;
}

export class LoadedSettings {
  constructor(
    system: SettingsFile,
    user: SettingsFile,
    workspace: SettingsFile,
    errors: SettingsError[],
  ) {
    this.system = system;
    this.user = user;
    this.workspace = workspace;
    this.errors = errors;
    this._merged = this.computeMergedSettings();
  }
  readonly system: SettingsFile;
  readonly user: SettingsFile;
  readonly workspace: SettingsFile;
  readonly errors: SettingsError[];

  private _merged: Settings;

  get merged(): Settings {
    return this._merged;
  }

  private computeMergedSettings(): Settings {
    const system = this.system.settings;
    const user = this.user.settings;
    const workspace = this.workspace.settings;

    return {
      ...user,
      ...workspace,
      ...system,
      customThemes: {
        ...(user.customThemes || {}),
        ...(workspace.customThemes || {}),
        ...(system.customThemes || {}),
      },
      mcpServers: {
        ...(user.mcpServers || {}),
        ...(workspace.mcpServers || {}),
        ...(system.mcpServers || {}),
      },
    };
  }
}
```

## 설정 업데이트



```typescript
forScope(scope: SettingScope): SettingsFile {
  switch (scope) {
    case SettingScope.User:
      return this.user;
    case SettingScope.Workspace:
      return this.workspace;
    case SettingScope.System:
      return this.system;
    default:
      throw new Error(`Invalid scope: ${scope}`);
  }
}

setValue<K extends keyof Settings>(
  scope: SettingScope,
  key: K,
  value: Settings[K],
): void {
  const settingsFile = this.forScope(scope);
  settingsFile.settings[key] = value;
  this._merged = this.computeMergedSettings();
  saveSettings(settingsFile);
}
```

# loadSettings()

> 시스템, 사용자, 워크스페이스 레벨의 설정을 모두 로드하여 `LoadedSettings` 객체로 반환하는 함수

`packages/cli/config/settings.ts` 파일에서 정의되어 있으며, 이 함수는 여러 설정 파일을 로드하고 병합하여 최종 설정을 반환

```typescript
loadEnvironment();
let systemSettings: Settings = {};
let userSettings: Settings = {};
let workspaceSettings: Settings = {};
const settingsErrors: SettingsError[] = [];
const systemSettingsPath = getSystemSettingsPath();
```

* loadEnvironment : **dotenv** 패키지를 사용하여 `.env` 파일에서 환경 변수 로드
* 여러 세팅값 들을 초기화
  * `systemSettings` : 시스템 설정
  * `userSettings` : 사용자 설정
  * `workspaceSettings` : 작업 공간 설정
  * `settingsErrors` : 설정 에러 목록
* `getSystemSettingsPath` : OS별로 다른 시스템 설정 경로 가져오기


## loadEnvironment - [레거시]

```typescript
export function loadEnvironment(): void {
  const envFilePath = findEnvFile(process.cwd());

  if (process.env.CLOUD_SHELL === 'true') {
    setUpCloudShellEnvironment(envFilePath);
  }

  if (envFilePath) {
    dotenv.config({ path: envFilePath, quiet: true });
  }
}
```

## getSystemSettingsPath

```typescript
export function getSystemSettingsPath(): string {
  if (process.env.GEMINI_CLI_SYSTEM_SETTINGS_PATH) {
    return process.env.GEMINI_CLI_SYSTEM_SETTINGS_PATH;
  }
  if (platform() === 'darwin') {
    return '/Library/Application Support/GeminiCli/settings.json';
  } else if (platform() === 'win32') {
    return 'C:\\ProgramData\\gemini-cli\\settings.json';
  } else {
    return '/etc/gemini-cli/settings.json';
  }
}
```

# 경로 정규화 및 심링크 처리

TODO: 디버깅 해서 결과 처리


# User Settings

여기선 user 설정을 로드하는것 까지만 정리

```typescript
import path from 'path';
import { homedir } from 'os';

export const SETTINGS_DIRECTORY_NAME = '.gemini';
export const USER_SETTINGS_DIR = path.join(homedir(), SETTINGS_DIRECTORY_NAME);
export const USER_SETTINGS_PATH = path.join(USER_SETTINGS_DIR, 'settings.json');
```

`settings.ts` 최상단 세팅값, 이것 이외에도 여러 타입들과 위 함수들(loadSettings, getSystemSettingsPath 등)도 정의되어 있음

```typescript
// Load user settings
try {
  if (fs.existsSync(USER_SETTINGS_PATH)) {
    const userContent = fs.readFileSync(USER_SETTINGS_PATH, 'utf-8');
    const parsedUserSettings = JSON.parse(
      stripJsonComments(userContent),
    ) as Settings;
    userSettings = resolveEnvVarsInObject(parsedUserSettings);
    // Support legacy theme names
    if (userSettings.theme && userSettings.theme === 'VS') {
      userSettings.theme = DefaultLight.name;
    } else if (userSettings.theme && userSettings.theme === 'VS2015') {
      userSettings.theme = DefaultDark.name;
    }
  }
} catch (error: unknown) {
  settingsErrors.push({
    message: getErrorMessage(error),
    path: USER_SETTINGS_PATH,
  });
}
```

1. `./gemini/settings.json` 파일을 utf-8 로 읽기
2. `stripJsonComments` 함수를 사용하여 주석 제거
3. JSON 파싱 후 `Settings` 타입으로 변환
4. `resolveEnvVarsInObject` 함수를 사용하여 환경 변수 치환
  * 설정값 내의 `$VAR_NAME` 또는 `${VAR_NAME}` 형태의 환경변수를 실제 값으로 치환
5. 에러 발생시 `settingsErrors` 배열에 에러 메시지와 경로 추가


# new LoadedSettings

이후 `loadEnvironment` 함수를 호출하여 환경 변수를 로드한 다음, `LoadedSettings` 인스턴스를 생성한 후 Return

```typescript
// Create LoadedSettings first
const loadedSettings = new LoadedSettings(
  {
    path: systemSettingsPath,
    settings: systemSettings,
  },
  {
    path: USER_SETTINGS_PATH,
    settings: userSettings,
  },
  {
    path: workspaceSettingsPath,
    settings: workspaceSettings,
  },
  settingsErrors,
);
```

# loadEnvironment

`process.env` 는 Node.js 의 전격 객체로서 해당 객체를 직접 수정하는 함수
